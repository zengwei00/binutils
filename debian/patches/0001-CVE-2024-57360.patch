From 9a3ecba038b5b21a9c945a78bd8a8112a4a37727 Mon Sep 17 00:00:00 2001
From: zengwei <zengwei1@uniontech.com>
Date: Fri, 18 Jul 2025 17:19:16 +0800
Subject: [PATCH] CVE-2024-57360

---
 binutils/nm.c | 24 ++++++++++++++++--------
 1 file changed, 16 insertions(+), 8 deletions(-)

diff --git a/binutils/nm.c b/binutils/nm.c
index f96cfa31..5c238a3c 100644
--- a/binutils/nm.c
+++ b/binutils/nm.c
@@ -677,7 +677,7 @@ print_symname (const char *form, struct extended_symbol_info *info,
 	       const char *name, bfd *abfd)
 {
   char *alloc = NULL;
-  char *atver = NULL;
+  char *atname = NULL;
 
   if (name == NULL)
     name = info->sinfo->name;
@@ -685,9 +685,19 @@ print_symname (const char *form, struct extended_symbol_info *info,
   if (!with_symbol_versions
       && bfd_get_flavour (abfd) == bfd_target_elf_flavour)
     {
-      atver = strchr (name, '@');
+      char *atver = strchr (name, '@');
+
       if (atver)
-	*atver = 0;
+	      {
+         /* PR 32467 - Corrupt binaries might include an @ character in a
+            symbol name.  Since non-versioned symbol names can be in
+            read-only memory (via memory mapping of a file's contents) we
+            cannot just replace the @ character with a NUL.  Instead we
+            create a truncated copy of the name.  */
+         atname = xstrdup (name);
+         atname [atver - name] = 0;
+         name = atname;
+       }
     }
 
   if (do_demangle && *name)
@@ -698,9 +708,7 @@ print_symname (const char *form, struct extended_symbol_info *info,
     }
 
   if (unicode_display != unicode_default)
-    {
-      name = convert_utf8 (name);
-    }
+    name = convert_utf8 (name);
 
   if (info != NULL && info->elfinfo && with_symbol_versions)
     {
@@ -721,8 +729,8 @@ print_symname (const char *form, struct extended_symbol_info *info,
 	}
     }
   printf (form, name);
-  if (atver)
-    *atver = '@';
+  
+  free (atname);
   free (alloc);
 }
 
-- 
2.20.1

